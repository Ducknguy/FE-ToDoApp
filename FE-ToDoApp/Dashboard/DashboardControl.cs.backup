using System;
using System.Collections.Generic;
using System.Data.SQLite;
using System.Drawing;
using System.IO;
using System.Windows.Forms;
using System.Globalization;
using FE_ToDoApp.Database;

namespace FE_ToDoApp.Dashboard
{
    public partial class DashboardControl : UserControl
    {
        public DashboardControl()
        {
            InitializeComponent();
            LoadDashboardData();
        }

        public void LoadDashboardData()
        {
            try
            {
                lblDate.Text = DateTime.Now.ToString("dddd, dd/MM/yyyy", new CultureInfo("vi-VN"));
            }
            catch
            {
                lblDate.Text = DateTime.Now.ToString("dddd, dd/MM/yyyy");
            }

            flowStats.Controls.Clear();
            tblLists.Controls.Clear();

            try
            {
                using (SQLiteConnection conn = SQLiteHelper.GetConnection())
                {
                    conn.Open();
                    
                    // Ki?m tra xem các b?ng có t?n t?i không
                    if (!CheckTablesExist(conn))
                    {
                        ShowEmptyDashboard("Database ch?a ???c kh?i t?o ??y ??.");
                        return;
                    }
                    
                    LoadStats(conn);

                    // --- PH?N 1: CÔNG VI?C S?P T?I (Upcoming) ---
                    Panel pnlToday = CreateListCard("Các công vi?c s?p t?i");

                    string sqlUpcoming = @"
                        SELECT 
                            i.Id_weekly AS ID, 
                            i.Title, 
                            i.StartDate AS TaskDate, 
                            i.Status, 
                            d.CategoryName AS GroupName,
                            'Calendar' AS SourceType
                        FROM WeekCategory_item i
                        JOIN WeekCategory_detail d ON i.CategoryId = d.CategoryId
                        WHERE date(i.StartDate) >= date('now', 'localtime')
                        
                        UNION ALL
                        
                        SELECT 
                            t.id_item AS ID, 
                            t.item_detail AS Title, 
                            l.created_at AS TaskDate, 
                            t.status AS Status, 
                            l.title AS GroupName,
                            'Todo' AS SourceType
                        FROM Todo_List_Item t
                        JOIN Todo_List_Detail l ON t.id_todo = l.id_todo
                        WHERE date(l.created_at) >= date('now', 'localtime')

                        ORDER BY TaskDate ASC";

                    LoadTasksToContainer(conn, pnlToday, sqlUpcoming, true);
                    tblLists.Controls.Add(pnlToday, 0, 0);

                    // --- PH?N 2: CÔNG VI?C QUÁ H?N (Overdue) ---
                    Panel pnlOverdue = CreateListCard("Các công vi?c quá h?n");

                    string sqlOverdue = @"
                        SELECT 
                            i.Id_weekly AS ID, 
                            i.Title, 
                            i.StartDate AS TaskDate, 
                            i.Status, 
                            d.CategoryName AS GroupName,
                            'Calendar' AS SourceType
                        FROM WeekCategory_item i
                        JOIN WeekCategory_detail d ON i.CategoryId = d.CategoryId
                        WHERE date(i.StartDate) < date('now', 'localtime') AND i.Status = 0
                        
                        UNION ALL
                        
                        SELECT 
                            t.id_item AS ID, 
                            t.item_detail AS Title, 
                            l.created_at AS TaskDate, 
                            t.status AS Status, 
                            l.title AS GroupName,
                            'Todo' AS SourceType
                        FROM Todo_List_Item t
                        JOIN Todo_List_Detail l ON t.id_todo = l.id_todo
                        WHERE date(l.created_at) < date('now', 'localtime') AND (t.status = 0 OR t.status IS NULL)

                        ORDER BY TaskDate ASC";

                    LoadTasksToContainer(conn, pnlOverdue, sqlOverdue, false);
                    tblLists.Controls.Add(pnlOverdue, 1, 0);
                }
            }
            catch (Exception ex)
            {
                ShowEmptyDashboard("L?i Dashboard: " + ex.Message);
            }
        }

        private void ShowEmptyDashboard(string message)
        {
            // Hi?n th? stats m?c ??nh
            flowStats.Controls.Add(CreateStatCard("0", "Hôm nay", Color.AliceBlue, "??"));
            flowStats.Controls.Add(CreateStatCard("0", "S?p t?i", Color.Beige, "??"));
            flowStats.Controls.Add(CreateStatCard("0", "Quá h?n", Color.MistyRose, "??"));
            flowStats.Controls.Add(CreateStatCard("0", "Hoàn thành", Color.Honeydew, "?"));

            // Hi?n th? thông báo
            Panel pnlMessage = new Panel
            {
                Dock = DockStyle.Fill,
                BackColor = Color.White,
                Margin = new Padding(15),
                Padding = new Padding(20)
            };

            Label lblMessage = new Label
            {
                Text = message + "\n\nHãy thêm công vi?c m?i ?? b?t ??u s? d?ng Dashboard.",
                Font = new Font("Segoe UI", 12, FontStyle.Regular),
                ForeColor = Color.Gray,
                Location = new Point(50, 100),
                AutoSize = true,
                TextAlign = ContentAlignment.MiddleCenter
            };

            pnlMessage.Controls.Add(lblMessage);
            tblLists.Controls.Add(pnlMessage, 0, 0);
            tblLists.SetColumnSpan(pnlMessage, 2);
        }

        private bool CheckTablesExist(SQLiteConnection conn)
        {
            try
            {
                string[] requiredTables = { "WeekCategory_item", "WeekCategory_detail", "Todo_List_Item", "Todo_List_Detail" };
                
                foreach (string tableName in requiredTables)
                {
                    string query = $"SELECT name FROM sqlite_master WHERE type='table' AND name='{tableName}'";
                    using (SQLiteCommand cmd = new SQLiteCommand(query, conn))
                    {
                        var result = cmd.ExecuteScalar();
                        if (result == null)
                        {
                            return false;
                        }
                    }
                }
                return true;
            }
            catch
            {
                return false;
            }
        }

        private void LoadTasksToContainer(SQLiteConnection conn, Panel card, string query, bool showCheckbox)
        {
            FlowLayoutPanel container = (FlowLayoutPanel)card.Controls["listContainer"];

            int rowWidth = container.ClientSize.Width + 520;
            if (rowWidth <= 0) rowWidth = 400;

            try
            {
                using (SQLiteCommand cmd = new SQLiteCommand(query, conn))
                {
                    using (SQLiteDataReader reader = cmd.ExecuteReader())
                    {
                        if (!reader.HasRows)
                        {
                            Label lblEmpty = new Label
                            {
                                Text = "Ch?a có công vi?c nào",
                                Font = new Font("Segoe UI", 10, FontStyle.Italic),
                                ForeColor = Color.Gray,
                                Location = new Point(15, 10),
                                AutoSize = true
                            };
                            container.Controls.Add(lblEmpty);
                            return;
                        }

                        while (reader.Read())
                        {
                            try
                            {
                                int id = Convert.ToInt32(reader["ID"]);
                                string title = reader["Title"]?.ToString() ?? "Không có tiêu ??";
                                string categoryName = reader["GroupName"]?.ToString() ?? "Ch?a phân lo?i";
                                string sourceType = reader["SourceType"]?.ToString() ?? "Unknown";

                                string fullDisplayTitle = $"{categoryName} - {title}";
                                DateTime taskDate = Convert.ToDateTime(reader["TaskDate"]);

                                int statusInt = 0;
                                if (reader["Status"] != DBNull.Value)
                                    statusInt = Convert.ToInt32(reader["Status"]);

                                bool isDone = (statusInt == 1);

                                Color color = Color.DodgerBlue;
                                if (!isDone && taskDate.Date < DateTime.Now.Date) color = Color.OrangeRed;
                                if (isDone) color = Color.SeaGreen;

                                string timeInfo = "";
                                try
                                {
                                    timeInfo = taskDate.ToString("dddd, dd/MM/yyyy", new CultureInfo("vi-VN"));
                                }
                                catch
                                {
                                    timeInfo = taskDate.ToString("dddd, dd/MM/yyyy");
                                }

                                container.Controls.Add(CreateTaskRow(id, fullDisplayTitle, timeInfo, color, isDone, showCheckbox, rowWidth, sourceType));
                            }
                            catch (Exception ex)
                            {
                                // B? qua task l?i và ti?p t?c v?i task khác
                                System.Diagnostics.Debug.WriteLine($"Error loading task: {ex.Message}");
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Label lblError = new Label
                {
                    Text = "L?i t?i d? li?u: " + ex.Message,
                    Font = new Font("Segoe UI", 9, FontStyle.Regular),
                    ForeColor = Color.Red,
                    Location = new Point(15, 10),
                    AutoSize = true
                };
                container.Controls.Add(lblError);
            }
        }

        private Panel CreateTaskRow(int taskId, string title, string info, Color tagColor, bool isDone, bool showCheckbox, int width, string sourceType)
        {
            Panel row = new Panel
            {
                Size = new Size(width, 55),
                Margin = new Padding(0, 5, 0, 5)
            };

            int textX = showCheckbox ? 35 : 15;

            Label lblBadge = new Label
            {
                Text = sourceType,
                AutoSize = true,
                Font = new Font("Segoe UI", 9, FontStyle.Bold),
                Padding = new Padding(3),
                Location = new Point(width - 160, 15),
                Anchor = AnchorStyles.Right
            };

            if (sourceType == "Calendar")
            {
                lblBadge.BackColor = Color.MistyRose;
                lblBadge.ForeColor = Color.Maroon;
            }
            else
            {
                lblBadge.BackColor = Color.LightSkyBlue;
                lblBadge.ForeColor = Color.Navy;
            }

            if (isDone)
            {
                row.BackColor = Color.FromArgb(240, 255, 240);

                if (showCheckbox)
                {
                    CheckBox ck = new CheckBox { Checked = true, Width = 25, Location = new Point(10, 18), Cursor = Cursors.Hand };
                    ck.Click += (s, e) => { ToggleTaskStatus(taskId, false, sourceType); };
                    row.Controls.Add(ck);
                }

                Label lblT = new Label
                {
                    Text = title,
                    Font = new Font("Segoe UI", 10, FontStyle.Strikeout),
                    ForeColor = Color.Gray,
                    Location = new Point(40, 8),
                    AutoSize = true
                };
                row.Controls.Add(lblT);

                Label lblI = new Label
                {
                    Text = info,
                    Font = new Font("Segoe UI", 9, FontStyle.Regular),
                    ForeColor = Color.Gray,
                    Location = new Point(40, 30),
                    AutoSize = true
                };
                row.Controls.Add(lblI);

                Button btnDel = new Button
                {
                    Text = "???",
                    Size = new Size(30, 30),
                    Location = new Point(width - 50, 12),
                    Anchor = AnchorStyles.Right,
                    FlatStyle = FlatStyle.Flat,
                    BackColor = Color.Transparent,
                    ForeColor = Color.Red,
                    Cursor = Cursors.Hand
                };
                btnDel.FlatAppearance.BorderSize = 0;
                btnDel.Click += (s, e) => {
                    if (MessageBox.Show("Xóa công vi?c này?", "Xác nh?n", MessageBoxButtons.YesNo) == DialogResult.Yes)
                        DeleteTask(taskId, sourceType);
                };
                row.Controls.Add(btnDel);

                row.Controls.Add(lblBadge);

                Panel dot = new Panel
                {
                    BackColor = Color.ForestGreen,
                    Size = new Size(5, 40),
                    Location = new Point(width - 5, 8),
                    Anchor = AnchorStyles.Right
                };
                row.Controls.Add(dot);
            }
            else
            {
                row.BackColor = Color.White;

                if (showCheckbox)
                {
                    CheckBox ck = new CheckBox { Checked = false, Width = 25, Location = new Point(5, 18), Cursor = Cursors.Hand };
                    ck.Click += (s, e) => { ToggleTaskStatus(taskId, true, sourceType); };
                    row.Controls.Add(ck);
                }

                Label lblT = new Label
                {
                    Text = title,
                    Font = new Font("Segoe UI", 10, FontStyle.Bold),
                    ForeColor = Color.Black,
                    Location = new Point(textX, 8),
                    AutoSize = true
                };

                Label lblI = new Label
                {
                    Text = info,
                    Font = new Font("Segoe UI", 9, FontStyle.Regular),
                    ForeColor = Color.Gray,
                    Location = new Point(textX, 30),
                    AutoSize = true
                };

                Button btnDel = new Button
                {
                    Text = "???",
                    Size = new Size(30, 30),
                    Location = new Point(width - 50, 12),
                    Anchor = AnchorStyles.Right,
                    FlatStyle = FlatStyle.Flat,
                    BackColor = Color.Transparent,
                    ForeColor = Color.Red,
                    Cursor = Cursors.Hand
                };
                btnDel.FlatAppearance.BorderSize = 0;
                btnDel.Click += (s, e) => {
                    if (MessageBox.Show("Xóa công vi?c này?", "Xác nh?n", MessageBoxButtons.YesNo) == DialogResult.Yes)
                        DeleteTask(taskId, sourceType);
                };

                Panel dot = new Panel
                {
                    BackColor = tagColor,
                    Size = new Size(5, 40),
                    Location = new Point(width - 5, 8),
                    Anchor = AnchorStyles.Right
                };

                row.Controls.AddRange(new Control[] { lblT, lblI, btnDel, dot, lblBadge });
            }

            return row;
        }

        private void ToggleTaskStatus(int id, bool isChecked, string sourceType)
        {
            try
            {
                string query = "";
                string statusVal = isChecked ? "1" : "0";

                if (sourceType == "Calendar")
                {
                    query = $"UPDATE WeekCategory_item SET Status = {statusVal} WHERE Id_weekly = {id}";
                }
                else
                {
                    query = $"UPDATE Todo_List_Item SET status = {statusVal} WHERE id_item = {id}";
                }

                ExecuteSql(query, cmd => { });
                LoadDashboardData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("L?i c?p nh?t tr?ng thái: " + ex.Message, "L?i", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void DeleteTask(int id, string sourceType)
        {
            try
            {
                string query = "";
                if (sourceType == "Calendar")
                {
                    query = $"DELETE FROM WeekCategory_item WHERE Id_weekly = {id}";
                }
                else
                {
                    query = $"DELETE FROM Todo_List_Item WHERE id_item = {id}";
                }

                ExecuteSql(query, cmd => { });
                LoadDashboardData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("L?i xóa công vi?c: " + ex.Message, "L?i", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void ExecuteSql(string query, Action<SQLiteCommand> paramBuilder)
        {
            try
            {
                using (SQLiteConnection conn = SQLiteHelper.GetConnection())
                {
                    conn.Open();
                    using (SQLiteCommand cmd = new SQLiteCommand(query, conn))
                    {
                        paramBuilder(cmd);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch (Exception ex) 
            { 
                MessageBox.Show("L?i: " + ex.Message, "L?i", MessageBoxButtons.OK, MessageBoxIcon.Error); 
            }
        }

        private void LoadStats(SQLiteConnection conn)
        {
            try
            {
                // 1. TODAY
                string sqlToday = @"SELECT 
                    COALESCE((SELECT COUNT(*) FROM WeekCategory_item WHERE date(StartDate) = date('now', 'localtime')), 0) + 
                    COALESCE((SELECT COUNT(*) FROM Todo_List_Item t JOIN Todo_List_Detail l ON t.id_todo = l.id_todo WHERE date(l.created_at) = date('now', 'localtime')), 0)";
                int today = GetCount(conn, sqlToday);

                // 2. UPCOMING
                string sqlUpcoming = @"SELECT 
                    COALESCE((SELECT COUNT(*) FROM WeekCategory_item WHERE date(StartDate) > date('now', 'localtime')), 0) + 
                    COALESCE((SELECT COUNT(*) FROM Todo_List_Item t JOIN Todo_List_Detail l ON t.id_todo = l.id_todo WHERE date(l.created_at) > date('now', 'localtime')), 0)";
                int upcoming = GetCount(conn, sqlUpcoming);

                // 3. OVERDUE
                string sqlOverdue = @"SELECT 
                    COALESCE((SELECT COUNT(*) FROM WeekCategory_item WHERE date(StartDate) < date('now', 'localtime') AND Status = 0), 0) + 
                    COALESCE((SELECT COUNT(*) FROM Todo_List_Item t JOIN Todo_List_Detail l ON t.id_todo = l.id_todo WHERE date(l.created_at) < date('now', 'localtime') AND (t.status = 0 OR t.status IS NULL)), 0)";
                int overdue = GetCount(conn, sqlOverdue);

                // 4. DONE
                string sqlDone = @"SELECT 
                    COALESCE((SELECT COUNT(*) FROM WeekCategory_item WHERE Status = 1), 0) + 
                    COALESCE((SELECT COUNT(*) FROM Todo_List_Item WHERE status = 1), 0)";
                int done = GetCount(conn, sqlDone);

                flowStats.Controls.Add(CreateStatCard(today.ToString(), "Hôm nay", Color.AliceBlue, "??"));
                flowStats.Controls.Add(CreateStatCard(upcoming.ToString(), "S?p t?i", Color.Beige, "??"));
                flowStats.Controls.Add(CreateStatCard(overdue.ToString(), "Quá h?n", Color.MistyRose, "??"));
                flowStats.Controls.Add(CreateStatCard(done.ToString(), "Hoàn thành", Color.Honeydew, "?"));
            }
            catch (Exception ex)
            {
                // N?u l?i, hi?n th? stats m?c ??nh
                flowStats.Controls.Add(CreateStatCard("0", "Hôm nay", Color.AliceBlue, "??"));
                flowStats.Controls.Add(CreateStatCard("0", "S?p t?i", Color.Beige, "??"));
                flowStats.Controls.Add(CreateStatCard("0", "Quá h?n", Color.MistyRose, "??"));
                flowStats.Controls.Add(CreateStatCard("0", "Hoàn thành", Color.Honeydew, "?"));
                
                System.Diagnostics.Debug.WriteLine("Error loading stats: " + ex.Message);
            }
        }

        private int GetCount(SQLiteConnection conn, string query)
        {
            try
            {
                using (SQLiteCommand cmd = new SQLiteCommand(query, conn))
                {
                    var result = cmd.ExecuteScalar();
                    return result != null && result != DBNull.Value ? Convert.ToInt32(result) : 0;
                }
            }
            catch
            {
                return 0;
            }
        }

        private Panel CreateStatCard(string value, string title, Color bgColor, string icon)
        {
            Panel card = new Panel { Size = new Size(220, 130), BackColor = Color.White, Margin = new Padding(10) };
            card.Paint += (s, e) => ControlPaint.DrawBorder(e.Graphics, card.ClientRectangle, Color.FromArgb(230, 230, 230), ButtonBorderStyle.Solid);
            Label lblVal = new Label { Text = value, Font = new Font("Segoe UI", 22, FontStyle.Bold), Location = new Point(15, 10), AutoSize = true };
            Label lblTit = new Label { Text = title, ForeColor = Color.DimGray, Location = new Point(15, 60), AutoSize = true };
            Label lblIcon = new Label { Text = icon, Location = new Point(170, 15), Font = new Font("Segoe UI", 18), AutoSize = true };
            Panel footer = new Panel { BackColor = bgColor, Dock = DockStyle.Bottom, Height = 5 };
            card.Controls.AddRange(new Control[] { lblVal, lblTit, lblIcon, footer });
            return card;
        }

        private Panel CreateListCard(string title)
        {
            Panel card = new Panel { Dock = DockStyle.Fill, BackColor = Color.White, Margin = new Padding(15), Padding = new Padding(10) };
            card.Paint += (s, e) => ControlPaint.DrawBorder(e.Graphics, card.ClientRectangle, Color.FromArgb(230, 230, 230), ButtonBorderStyle.Solid);
            Label lbl = new Label { Text = title, Font = new Font("Segoe UI", 14, FontStyle.Bold), Location = new Point(15, 15), AutoSize = true };
            FlowLayoutPanel listContainer = new FlowLayoutPanel { Name = "listContainer", FlowDirection = FlowDirection.TopDown, WrapContents = false, Location = new Point(15, 60), Size = new Size(card.Width - 30, 350), AutoScroll = true, Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right | AnchorStyles.Bottom };
            card.Controls.Add(lbl); 
            card.Controls.Add(listContainer);
            return card;
        }
    }
}
